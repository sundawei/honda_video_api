# IP Camera Recorder API - 部署说明

## 📦 包含文件

本便携版已包含所有必要的Python依赖包，无需额外安装。

### 文件结构
```
recoder/
├── libs/                   # Python依赖包（已包含）
├── recordings/             # 录像文件存储目录
├── logs/                   # 日志文件目录
├── static/                 # 静态资源
├── templates/              # HTML模板
├── app.py                  # 主程序
├── recorder.py             # 录像模块
├── recording_manager.py    # 录像管理器
├── camera_manager.py       # 摄像机管理器
├── video_processor.py      # 视频处理器
├── config.yaml            # 配置文件
├── start_api.bat          # Windows启动脚本
└── start_api_portable.bat # 便携版启动脚本
```

## 🚀 快速开始

### 1. 系统要求

- **操作系统**: Windows 7/10/11
- **Python**: 3.7 或更高版本
- **FFmpeg**: 用于视频录制（必需）

### 2. 安装前置软件

#### 安装Python（如果未安装）
1. 访问 https://www.python.org/downloads/
2. 下载Python 3.7+版本
3. 安装时勾选"Add Python to PATH"

#### 安装FFmpeg（必需）
1. 访问 https://ffmpeg.org/download.html
2. 下载Windows版本
3. 解压到任意目录（如：C:\ffmpeg）
4. 将FFmpeg的bin目录添加到系统PATH
   - 右键"此电脑" → 属性 → 高级系统设置
   - 环境变量 → 系统变量 → Path → 编辑
   - 新建 → 输入FFmpeg的bin路径（如：C:\ffmpeg\bin）

### 3. 启动服务

#### 方法一：双击启动（推荐）
直接双击 `start_api.bat` 文件

#### 方法二：命令行启动
```bash
cd recoder
python app.py
```

### 4. 访问服务

服务启动后，可通过以下地址访问：
- API文档: http://127.0.0.1:9999/docs
- 健康检查: http://127.0.0.1:9999/api/health

## ⚙️ 配置说明

编辑 `config.yaml` 文件配置摄像机：

```yaml
cameras:
  - id: camera_01
    name: "前门摄像机"
    rtsp_url: "rtsp://admin:password@192.168.1.100:554/stream"
    enabled: true

recording:
  output_dir: "recordings"  # 录像保存目录
  segment_duration: 600      # 每段录像时长（秒）
  retention_days: 7          # 录像保留天数
```

## 📝 API接口

### 基础接口
- `GET /api/health` - 健康检查
- `GET /api/status` - 系统状态
- `GET /api/cameras` - 获取摄像机列表

### 录像控制
- `POST /api/recording/start` - 开始录像
  ```json
  {"camera_id": "camera_01"}
  ```

- `POST /api/recording/stop` - 停止录像
  ```json
  {"camera_id": "camera_01"}
  ```

- `POST /api/recording/query` - 查询录像
  ```json
  {
    "camera_id": "camera_01",
    "start_time": "2024-01-01T00:00:00",
    "end_time": "2024-01-01T23:59:59"
  }
  ```

## 🔧 故障排除

### 问题1：提示找不到Python
**解决方案**：
1. 确认已安装Python 3.7+
2. 确认Python已添加到PATH
3. 在命令行运行 `python --version` 检查

### 问题2：提示找不到FFmpeg
**解决方案**：
1. 确认已安装FFmpeg
2. 确认FFmpeg已添加到PATH
3. 在命令行运行 `ffmpeg -version` 检查

### 问题3：录像无法开始
**可能原因**：
1. RTSP地址错误
2. 摄像机账号密码错误
3. 网络连接问题
4. 防火墙阻止

**解决方案**：
1. 检查config.yaml中的RTSP地址
2. 使用VLC等工具测试RTSP流是否正常
3. 检查防火墙设置

### 问题4：端口被占用
**解决方案**：
修改app.py最后一行的端口号：
```python
uvicorn.run(app, host="0.0.0.0", port=9999)  # 修改9999为其他端口
```

## 📞 技术支持

如遇到问题，请检查：
1. `logs/app.log` - 应用日志
2. 控制台输出信息

## 📋 注意事项

1. **首次运行**会自动创建必要的目录
2. **录像文件**默认保存在recordings目录
3. **日志文件**保存在logs目录
4. **自动清理**会定期删除过期录像（默认7天）

## 🔐 安全建议

1. 修改默认端口号
2. 配置防火墙规则
3. 定期更新摄像机密码
4. 限制API访问来源

---

版本: 1.0.0
更新日期: 2024