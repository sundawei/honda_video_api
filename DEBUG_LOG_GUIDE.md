# 日志调试指南

## Python API 端日志

运行 Python API 服务时，会输出以下关键日志：

### 1. 查询请求日志
```
================================================================================
[QUERY] 开始查询录像
[QUERY] Camera ID: camera_01
[QUERY] Start Time: 2025-10-17 17:00:00
[QUERY] End Time: 2025-10-17 17:10:00
[QUERY] Duration: 10.00 minutes
================================================================================
```

**检查点**：
- 时间范围是否正确
- 时长计算是否合理

### 2. 文件查找日志
```
[QUERY] 找到 4 个录像文件
[QUERY] 文件 1: camera_01_20251017_170000_to_20251017_170100.mp4
         时间: 2025-10-17T17:00:00 to 2025-10-17T17:01:00
         时长: 60.0 seconds
```

**检查点**：
- 文件数量是否符合预期
- 每个文件的时间范围是否正确

### 3. Session处理日志
```
[SESSION] Created session directory: recordings/sessions/camera_01_20251017_170000_000_abc12345
[SESSION] Processing 4 video files

[PROCESS] 处理文件 1: camera_01_20251017_170000_to_20251017_170100.mp4
[PROCESS]   文件时间: 17:00:00 - 17:01:00
[PROCESS]   查询时段: 17:00:00 - 17:10:00
[PROCESS]   提取参数: start=0.0s, end=60.0s, duration=60.0s
[PROCESS]   决定: 使用整个文件 (文件时长=60.0s)
```

**检查点**：
- Session目录是否唯一
- 文件处理决策（使用整个文件 vs 截取）
- 提取参数是否正确

### 4. 结果返回日志
```
================================================================================
[QUERY RESULT] Session目录: recordings/sessions/camera_01_20251017_170000_000_abc12345
[QUERY RESULT] 返回文件数: 4
[QUERY RESULT] 总文件大小: 180.50 MB
[QUERY RESULT] 文件 1: camera_01_20251017_170000_to_20251017_170100.mp4
               路径: /mnt/d/wch/recoder/recordings/camera_01/...
               大小: 45.30 MB
================================================================================
```

**检查点**：
- 返回的文件数量
- 文件路径是否正确（原文件 vs clip文件）

## C# 程序端日志

### 1. CSV文件检测日志
```
========================================
[CSV] 检测到新CSV文件: data_001
[CSV] 时间: 2025-10-17 17:00:00
[CSV] 目录: C:\Monitor\
[CSV] Camera ID: camera_01
[CSV] 创建新录像段, 开始时间: 2025-10-17 17:00:00
```

### 2. 录像处理日志
```
[CSV] 处理上一段录像:
      开始时间: 2025-10-17 17:00:00
      结束时间: 2025-10-17 17:10:00
      时长: 10.00 分钟
========================================
```

**检查点**：
- 时间记录是否正确
- 第一个CSV不应该触发查询（需要等第二个CSV）

### 3. API调用日志
```
========================================
[API] 调用录像查询API
[API] Camera ID: camera_01
[API] Start Time: 2025-10-17 17:00:00
[API] End Time: 2025-10-17 17:10:00
[API] Duration: 10.00 分钟
```

### 4. API返回日志
```
[API] 返回文件数: 4
[API] 总文件大小: 180.50 MB
[API] 文件 1: camera_01_20251017_170000_to_20251017_170100.mp4
       路径: /mnt/d/wch/recoder/recordings/camera_01/...
       大小: 45.30 MB
```

## 常见问题诊断

### 问题1: 只返回1-2个文件
**可能原因**：
1. 查询时间范围太短
2. 文件时间解析错误
3. 最小片段时长过滤（5秒）

**检查日志**：
- 查看 `[QUERY] Duration` 是否正确
- 查看 `[PROCESS] 跳过: 文件不在查询时间段内` 信息
- 查看 `Skipping clip: duration too short` 警告

### 问题2: 文件时长不匹配
**可能原因**：
1. CSV时间记录错误（都用了DateTime.Now）
2. 文件截取计算错误

**检查日志**：
- 比较 C# 的 `[CSV] 时间` 和 `[API] Start/End Time`
- 查看 `[PROCESS] 提取参数` 是否合理

### 问题3: Session目录重复
**可能原因**：
1. 目录名没有唯一标识
2. 同一秒内多次查询

**检查日志**：
- 查看 `[SESSION] Created session directory` 是否每次都不同

## 调试步骤

1. **启动Python API服务**
   ```bash
   python app.py
   ```
   观察控制台输出

2. **运行C#程序**
   - 放入第一个CSV文件
   - 等待一段时间
   - 放入第二个CSV文件
   - 观察控制台输出

3. **对比日志**
   - C#记录的时间 vs API收到的时间
   - API查找的文件 vs 实际存在的文件
   - 返回的文件数 vs 期望的文件数

4. **检查文件系统**
   ```bash
   # 查看录像文件
   ls -la recordings/camera_01/

   # 查看session目录
   ls -la recordings/sessions/
   ```

## 日志保存

建议将日志重定向到文件：

**Python API**:
```bash
python app.py 2>&1 | tee api_debug.log
```

**C#程序**:
在代码中使用日志框架，或重定向控制台输出。